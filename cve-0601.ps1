$server_ou = (Get-ADOrganizationalUnit -Filter 'Name -like "Servers"').DistinguishedName 
$computers = Get-ADComputer -SearchBase $server_ou -Filter *
$server_Name = ''
$failed_connections = 'C:\failed_connections'

if(!(test-path $failed_connections ))
{ # Create folder if missing
    mkdir $failed_connections
}



ForEach($item in $computers.name)
{
    Write-Output "Connecting to: $item"
   
    try
    { # Check if ps session can be established
        $session = New-PSSession $item -ErrorAction Stop
    }
    catch  
    { # Log failure move on to next target
        Write-Host "Failed to connect to host $item.."
        $item | out-file "$failed_connections\failed_connections.txt" -Append
        continue
    }

    Invoke-Command -ScriptBlock  { mkdir c:\cve-2020-0601 } -ComputerName $item  

    $build_number = invoke-command -ScriptBlock  {[System.Environment]::OSVersion.Version.build} -ComputerName $item
    
    if($build_number -eq '14393')
    {
        # copy and install windows 2016 patch
        copy-item "\\$server_Name\cve-2020-0601\windows10.0-kb4534271-x64_a009e866038836e277b167c85c58bbf1e0cc5dc8.msu" "c:\cve-2020-0601" -ToSession $session
        Write-Host "Installing Patch for Server 2016 on $item"
        Invoke-Command -ScriptBlock  { 
            start-process  -FilePath "wusa.exe" -ArgumentList "c:\cve-2020-0601\windows10.0-kb4534271-x64_a009e866038836e277b167c85c58bbf1e0cc5dc8.msu /quiet /norestart" -Wait 
            Remove-Item "c:\cve-2020-0601" -Recurse -force 
        } -ComputerName $item 
    }
    elseif ($build_number -eq '17763' ) 
    {
        # copy and install windows 2019 patch
        copy-item "\\$server_Name\cve-2020-0601\windows10.0-kb4534273-x64_74bf76bc5a941bbbd0052caf5c3f956867e1de38.msu" "c:\cve-2020-0601" -ToSession $session
        Write-Host "Installing Patch for Server 2019 on $item"
        Invoke-Command -ScriptBlock  { 
            start-process  -FilePath "wusa.exe" -ArgumentList "c:\cve-2020-0601\windows10.0-kb4534273-x64_74bf76bc5a941bbbd0052caf5c3f956867e1de38.msu /quiet /norestart" -Wait 
            Remove-Item "c:\cve-2020-0601" -Recurse -force 
        } -ComputerName $item 
    }

    Remove-PSSession $session
}